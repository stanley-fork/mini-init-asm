#!/usr/bin/env bash
set -euo pipefail

BIN="/usr/bin/mini-init-asm"

echo "[autopkgtest] 0) version"
"$BIN" --version >/dev/null

echo "[autopkgtest] 1) graceful termination forwards TERM"
EP_GRACE_SECONDS=2 "$BIN" -v -- /bin/sh -c 'trap "exit 0" TERM; sleep 1000' &
pid=$!
sleep 0.5
kill -TERM "$pid"
wait "$pid"

echo "[autopkgtest] 2) escalation after grace"
EP_GRACE_SECONDS=1 "$BIN" -v -- /bin/sh -c 'trap "" TERM INT HUP QUIT; while :; do sleep 5; done' &
pid=$!
sleep 0.5
kill -TERM "$pid"
set +e
wait "$pid"
rc=$?
set -e
test "$rc" -eq 137

echo "[autopkgtest] 3) numeric EP_SIGNALS forwards SIGTRAP (5)"
EP_SIGNALS=5 "$BIN" -v -- /bin/sh -c 'trap "exit 0" TRAP; sleep 1000' &
pid=$!
sleep 0.5
kill -TRAP "$pid"
wait "$pid"

echo "[autopkgtest] 4) restart on crash"
# Create a script that exits on first run, succeeds on second run
cat > /tmp/crash_once.sh <<'CRASHEOF'
#!/bin/sh
if [ -f /tmp/restart_marker ]; then
    # Second run: exit normally
    exit 0
else
    # First run: create marker and crash
    touch /tmp/restart_marker
    exit 1
fi
CRASHEOF
chmod +x /tmp/crash_once.sh
rm -f /tmp/restart_marker
rm -f /tmp/restart.log
set +e
EP_RESTART_ENABLED=1 EP_MAX_RESTARTS=1 "$BIN" -v -- /tmp/crash_once.sh 2>&1 | tee /tmp/restart.log
rc=$?
set -e
# Should see "DEBUG: restarting child" in logs
if grep -q "DEBUG: restarting child" /tmp/restart.log; then
    echo "  ✓ Restart triggered"
else
    echo "  ✗ Restart not found in logs" >&2
    exit 1
fi
# Final exit code should be 0 (second run succeeded)
test "$rc" -eq 0
rm -f /tmp/crash_once.sh /tmp/restart_marker /tmp/restart.log

echo "[autopkgtest] 5) PGID fan-out (signal reaches grandchild)"
# Child spawns grandchild, both trap TERM, both should receive signal
cat > /tmp/pgid_test.sh <<'PGIDEOF'
#!/bin/sh
trap 'echo "grandchild got TERM" >> /tmp/pgid_test.log; exit 0' TERM
sleep 1000 &
GRANDCHILD_PID=$!
trap 'echo "child got TERM" >> /tmp/pgid_test.log; wait $GRANDCHILD_PID; exit 0' TERM
sleep 1000
PGIDEOF
chmod +x /tmp/pgid_test.sh
rm -f /tmp/pgid_test.log
"$BIN" -- /tmp/pgid_test.sh &
pid=$!
sleep 0.5
kill -TERM "$pid"
wait "$pid"
# Both child and grandchild should have logged
if grep -q "child got TERM" /tmp/pgid_test.log && grep -q "grandchild got TERM" /tmp/pgid_test.log; then
    echo "  ✓ Both child and grandchild received TERM"
else
    echo "  ✗ PGID fan-out failed" >&2
    cat /tmp/pgid_test.log >&2
    exit 1
fi
rm -f /tmp/pgid_test.sh /tmp/pgid_test.log

echo "[autopkgtest] OK"
